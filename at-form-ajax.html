<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="../at-core-activity/at-core-activity.html">
<link rel="import" href="../at-core-form/at-core-form.html">
<link rel="import" href="../at-core-spinner/at-core-spinner.html">
<link rel="import" href="../at-carbon-action-button/at-carbon-action-button.html">
<link rel="import" href="../at-carbon-alert/at-carbon-alert.html">
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html">
<link rel="import" href="../at-core-signals/at-core-signals.html">

<dom-module id="at-form-ajax">
  <template>

    <style>
      :host {
        position: relative;
        width: 100%;
        display: block;
      }

      .button-wrapper {
        margin-top: 10px;
        text-align: center;
      }

      button[disabled] {
        background-color: #eee;
        border: 1px solid #ababab;
        color: #ababab;
        cursor: default;
        filter: progid: DXImageTransform.Microsoft.Gradient(GradientType=0, startColorstr='#ffeeeeee', endColorstr='#ffeeeeee');
        background: -webkit-gradient(linear, 0 0, 0 100%, from(rgba(238, 238, 238, 1.0)), to(rgba(238, 238, 238, 1.0)));
        background: -moz-linear-gradient(top, rgba(238, 238, 238, 1.0), rgba(238, 238, 238, 1.0));
        text-shadow: none;
        -webkit-box-shadow: none;
        -moz-box-shadow: none;
        box-shadow: none;
      }
    </style>

    <at-core-spinner id="spinner" type="wave" display="none"></at-core-spinner>
    <at-carbon-alert id="invalidMessage">Please correct the marked fields with error(s) before submitting the form.</at-carbon-alert>
    <at-core-activity id="atFormAjaxSchemaActivity" url="{{schemaUrl}}" on-response="handleAjaxSchemaResponse" on-error="handleRequestError"></at-core-activity>
    <at-core-activity id="atFormAjaxRecordActivity" on-response="handleAjaxRecordResponse" on-error="handleRequestError"></at-core-activity>
    <at-core-activity id="atFormAjaxActivity" url="{{url}}" method="POST" on-response="handleAjaxPostResponse" on-error="handleRequestError"></at-core-activity>
    <at-core-form id="atFormAjaxForm" on-at-core-form-rendered="handleFormRendered"></at-core-form>

    <div id="btnWrapper" class="button-wrapper" style="display:none">
      <!--<button id="btnSubmitForm" type="button"><at-carbon-icon icon="now:checkmark"></at-carbon-icon></button>-->
        <at-carbon-action-button id="btnSubmitForm" xtype="submit" on-tap="handleFormSubmit"></at-carbon-action-button>
    </div>
  </template>
</dom-module>

<script>
  // On POST response, component will fire "at-form-ajax-post-response" event with e.detail as a value
    Polymer({
        is: "at-form-ajax",
        _scopeCssViaAttr: true,
        properties: {
            url: {
                type: String,
                value: ""
            },
            schemaUrl: {
                type: String,
                value: "",
                observer: "schemaUrlChanged"
            },
            schema: {
                type: Object,
                observer: "schemaChanged"
            },
            recordId: {
                type: String,
                value: "",
                observer: 'recordIdChanged'
            },
            mode: {
                type: String,
                value: "c",
                xtype: 'enum',
                title: 'Mode',
                xvaluelist: [{
                    title: "Create",
                    value: "c"
                }, {
                    title: "Update",
                    value: "u"
                }, {
                    title: "Read",
                    value: "r"
                }],
                observer: "modeChanged"
            },
            //Post Mode should be either json or formdata
            //default value is json
            postMode: {
                type: String,
                value: "json"
            }
        },

        //Internal flag that will be used to control if the component is busy or not
        //It is used to know if signal busy-start / busy-end should be set
        _busy: false,

        schemaChanged: function (newValue, oldValue) {
            this.fire("at-form-ajax-schema-changed", {
                schema: newValue
            });

            this.$.btnWrapper.style.display = "none";
            this.$.atFormAjaxForm.hide = true;

            this.$.atFormAjaxForm.schema = newValue;
        },

        recordIdChanged: function (newValue, oldValue) {
            if (!this._afterReady) {
                return;
            }

            if (!this.mode) {
                //Mode (if not specified) is dependant on existance of recordId
                //if recordId has value, mode is u-pdate
                //if recordId has no value, mode is c-reate
                this.mode = this.recordId ? "u" : "c";
            }

            if (this.url && newValue) {

                itemId = newValue;
                if (!this.url.endsWith("/")) {
                    itemId = "/" + itemId;
                }

                this.$.btnWrapper.style.display = "none";
                this.$.atFormAjaxForm.hide = true;

                this.$.atFormAjaxRecordActivity.url = this.url + itemId;
                this.$.atFormAjaxRecordActivity.generateRequest();

                this.$.spinner.display = "block";
                if (!this._busy) {
                    Polymer.signal("busy-start");
                    this._busy = true;
                }
            }
        },

        schemaUrlChanged: function (newValue, oldValue) {
            if (!this._afterReady) {
                return;
            }

            if (newValue) {
                this.generateSchemaRequest();
            }
        },

        modeChanged: function (newValue, oldValue) {
            if (!this._afterReady) {
                return;
            }

            if (newValue) {
                this.mode = newValue.toLowerCase();
            }

            if (!this.mode) {
                //Mode (if not specified) is dependant on existance of recordId
                //if recordId has value, mode is u-pdate
                //if recordId has no value, mode is c-reate
                this.mode = this.recordId ? "u" : "c";
            }

            this.generateSchemaRequest();
        },

        generateSchemaRequest: function () {
            if (this.schemaUrl && this.mode) {

                this.$.btnWrapper.style.display = "none";

                this.$.atFormAjaxForm.hide = true;

                //Clean up record error message, if there is any
                this.$.atFormAjaxRecordActivity.$.msg.html = "";

                this.$.atFormAjaxSchemaActivity.url = this.schemaUrl;
                this.$.atFormAjaxSchemaActivity.params["mode"] = this.mode;

                this.$.atFormAjaxSchemaActivity.generateRequest();

                this.$.spinner.display = "block";

                if (!this._busy) {
                    Polymer.signal("busy-start");
                    this._busy = true;
                }
            }
        },

        handleAjaxSchemaResponse: function (e) {
            if (e.detail.ErrorCode == 0) {
                //Form should be disabled if mode is set to read
                this.$.atFormAjaxForm.disabled = this.mode === "r";

                if (this.mode == "c" || this.mode == "u") {
                    //JS passes object ( schema.properties ) by reference,
                    //all changes made in this block will reflect to e.detail.Data.form.schema.properties
                    var schemaProperties = e.detail.Data.form.schema.properties;
                    if (schemaProperties) {
                        for (var property in schemaProperties) {
                            if (schemaProperties.hasOwnProperty(property) && schemaProperties[property].readOnly) {
                                delete schemaProperties[property];

                                //Faster way to do the same job, but currently not working as at-core-form can't handle undefined properties
                                //schema.properties[property] = undefined;
                            }
                        }
                    }
                }

                //This line here is required so it can reset form data
                this.$.atFormAjaxForm._internalData = {};
                this.schema = e.detail.Data.form.schema;
                this.url = e.detail.Data.form.url;

                //If mode != create and recordId is provided we should fetch data, otherwise recordId is ignored
                if (this.mode != "c" && this.recordId) {
                    if (this.url && this.recordId) {
                        console.log("Fetch form data for item with ID: " + this.recordId);
                        var itemId = this.recordId;
                        if (!this.url.endsWith("/")) {
                            itemId = "/" + itemId;
                        }
                        this.$.atFormAjaxRecordActivity.url = this.url + itemId;
                        this.$.atFormAjaxRecordActivity.generateRequest();

                        this.$.spinner.display = "block";
                        if (!this._busy) {
                            Polymer.signal("busy-start");
                            this._busy = true;
                        }
                    }
                } else {
                    // delay form showing or rendering to avoid FOUC IE11 and Safari
                    Polymer.dom.flush();
                    this.async(function () {
                        this.$.atFormAjaxForm.hide = false;
                        this.$.btnWrapper.style.display = "block";
                        this.$.atFormAjaxForm.setFocus();
                        this.$.spinner.display = "none";
                        if (this._busy) {
                            Polymer.signal("busy-end");
                            this._busy = false;
                        }
                    });
                }
            }
        },

        handleAjaxRecordResponse: function (e) {
            this.$.atFormAjaxForm.data = e.detail.Data;

            this.$.atFormAjaxForm.hide = false;
            this.$.spinner.display = "none";
            if (this._busy) {
                Polymer.signal("busy-end");
                this._busy = false;
            }

            //If form is in the read mode, submit button should not be displayed
            if (this.mode != "r") {
                this.$.btnWrapper.style.display = "block";
            }
        },

        handleAjaxPostResponse: function (e) {
            this.fire("at-form-ajax-post-response", {
                value: e.detail
            });
            this.$.atFormAjaxForm.disabled = false;

            if (e.detail.ErrorCode == 0) {
                this.recordId = e.detail.Data.id;
            }

            this.$.spinner.display = "none";
            if (this._busy) {
                Polymer.signal("busy-end");
                this._busy = false;
            }
            //this.$.btnSubmitForm.disabled = !this.$.atFormAjaxForm.valid;
        },

        handleFormRendered:function () {
            //Show submit button only if form is in create mode
            //If it is in update mode it will be shown later in the process
            //After the data is obtained and form filled with it
            if (this.mode == "c") {
                this.$.btnWrapper.style.display = "block";
                this.$.spinner.display = "none";
                if (this._busy) {
                    Polymer.signal("busy-end");
                    this._busy = false;
                }
            }
        },

        handleRequestError: function () {
            this.$.spinner.display = "none";
            if (this._busy) {
                Polymer.signal("busy-end");
                this._busy = false;
            }
        },

        handleFormSubmit:function (e) {

            if (!this.$.atFormAjaxForm.validate()) {
                this.$.invalidMessage.open();
                return;
            }

            var postData = {};
            this.$.atFormAjaxForm.disabled = true;
            this.$.btnSubmitForm.disabled = true;

            var postMode = this.postMode.toLowerCase();
            //We should check if user wants to upload files in this case
            if (postMode != "formdata") {
                //Check if user selected files to upload
                if (Object.getOwnPropertyNames(this.$.atFormAjaxForm.files).length > 0) {
                    //Some files are pending for upload, we should override postMode and use "formdata" mode
                    postMode = "formdata";
                }
            }

            if (postMode == "formdata") {
                this.$.atFormAjaxActivity.contentType = "multipart/form-data";
                postData = new FormData();

                var json = {};

                //RecordId should be passed only if form is in update mode
                if (this.mode == "u") {
                    json["id"] = this.recordId;
                }

                for (var key in this.schema.properties) {
                    if (this.schema.properties.hasOwnProperty(key)) {

                        console.log(key);
                        console.log(this.$.atFormAjaxForm.data[key]);

                        var files = this.$.atFormAjaxForm.files[key];
                        //If property is available then add files to the postData
                        if (files) {
                            for (var i = 0; i < files.length; i++) {
                                postData.append(key + "_" + files[i].name, files[i]);
                            }
                        }

                        //After the last change in at-form-file we send both files and data object with it ( containing deleted, current, valid and invalid properties )
                        json[key] = this.$.atFormAjaxForm.data[key];
                    }
                }

                postData.append("json", JSON.stringify(json));

            } else {
                this.$.atFormAjaxActivity.contentType = "application/json";

                //RecordId should be passed only if form is in update mode
                if (this.mode == "u") {
                    postData["id"] = this.recordId;
                }

                for (var key in this.schema.properties) {
                    if (this.schema.properties.hasOwnProperty(key)) {
                        postData[key] = this.$.atFormAjaxForm.data[key];
                    }
                }
            }

            this.$.atFormAjaxActivity.body = postData;
            this.$.atFormAjaxActivity.generateRequest();

            this.$.spinner.display = "block";
            if (!this._busy) {
                Polymer.signal("busy-start");
                this._busy = true;
            }
        },

        ready: function () {
            this._afterReady = true

            //Initially, mode (if not specified) is dependant on existance of recordId
            //if recordId has value, mode is u-pdate
            //if recordId has no value, mode is c-reate
            this.mode = this.recordId ? "u" : "c";

            this.generateSchemaRequest();
        }
    });
</script>
