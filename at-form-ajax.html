<link rel="import" href="../at-core-theme/at-core-theme.html">
<link rel="import" href="../at-core-form/at-core-form.html">
<link rel="import" href="../at-core-activity/at-core-activity.html">
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html">

<dom-module id="at-form-ajax">

<style>
    :host {
        position: relative;
        width: 100%;
        display: block;
    }

    .button-wrapper{
        margin-top:10px;
    }
</style>

<template>
    <at-core-theme></at-core-theme>
    <at-core-activity id="atFormAjaxActivity" url="{{url}}" method="POST"></at-core-activity>
    <at-core-form id="atFormAjaxForm"></at-core-form>

    <div class="button-wrapper">
        <button id="btnSubmitForm" type="button"><at-carbon-icon icon="now:checkmark"></at-carbon-icon></button>
    </div>
</template>
</dom-module>

<script>
Polymer({
    is: "at-form-ajax",
    _scopeCssViaAttr: true,
    properties: {
        _afterReady: {
            type: Boolean
        },
        url: {
            type: String,
            value: ""
        },
        schema: {
            type: Object,
            observer: "schemaChanged"
        },
        //Mode should be either json or formdata
        //default value is json
        mode: {
            type: String,
            value: "json"
        }
    },

    schemaChanged: function () {
        this.$.atFormAjaxForm.schema = this.schema;
    },

    ready: function () {
        this._afterReady = true;

        var self = this;

        this.$.atFormAjaxForm.addEventListener("response", function (e) {
            debugger;
        });

        this.$.atFormAjaxForm.addEventListener("data-changed", function (e) {
            self.$.btnSubmitForm.disabled = !this.valid;
        });

        this.$.btnSubmitForm.addEventListener("click", function (e) {
            var postData = {};
            if(self.mode.toLowerCase() == "formdata"){
                postData = new FormData();

                for (var key in self.schema.schema.properties) {
                    if (self.schema.schema.properties.hasOwnProperty(key)) {
                            formData.append(key, self.$.atFormAjaxForm.data[key]);
                    }
                }
                
                //self.$.atFormAjaxActivity.contentType = null;
            }else{
                self.$.atFormAjaxActivity.contentType = "application/json;odata=verbose";
                
                for (var key in self.schema.schema.properties) {
                    if (self.schema.schema.properties.hasOwnProperty(key)) {
                         postData[key] = self.$.atFormAjaxForm.data[key];
                    }
                }
            }

            //self.$.atFormAjaxActivity.params = null;
            self.$.atFormAjaxActivity.body = postData;
            self.$.atFormAjaxActivity.generateRequest();
        });

        this.$.btnSubmitForm.disabled = !this.$.atFormAjaxForm.valid;
    }
});
</script>

